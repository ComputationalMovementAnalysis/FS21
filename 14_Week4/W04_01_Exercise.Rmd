# Exercise 4

## Learning Outcomes
- You are able to implement a simple movement pattern using R.
- You understand the sensitivity of movement patterns to pattern parameter thresholds


## Prerequisites
Readings Skills from "R for Data Science" [@wickham2017]:

- RS4.1 Chap15 Functions (19p, 269-289)

Readings Theory, @laube2014
- R4.1 Chap.2, p. 29-58

## Preperation

Open your R Project from last week. Either run your own script from last week or the following lines to transform the data into the form we need for today's exercise.

```{r, echo = T, include = T, eval = T}
library(tidyverse)
library(CMAtools)
library(sf)

library(tibble)
library(readr)
# Import as tibble
wildschwein_BE <- read_delim("../CMA_FS2018_Filestorage/wildschwein_BE.csv",",")

# Convert to sf-object
wildschwein_BE = st_as_sf(wildschwein_BE, coords = c("Long", "Lat"), crs = 4326,remove = FALSE)

# transform to CH1903 LV95
wildschwein_BE <- st_transform(wildschwein_BE, 2056)

# Add geometry as E/N integer Columns
wildschwein_BE <- st_coordinates(wildschwein_BE) %>%
  cbind(wildschwein_BE,.) %>%
  rename(E = X) %>%
  rename(N = Y)

# Compute timelag, steplength and speed
wildschwein_BE <- wildschwein_BE %>%
  group_by(TierID) %>%
  mutate(
    timelag = as.numeric(difftime(lead(DatetimeUTC),DatetimeUTC,units = "secs")),
    steplength = euclid(lead(E, 1),lead(N, 1),E,N),
    speed = steplength/timelag
  )

```


## Tasks




### Task 5
<!-- Imported via copy and paste from E03 -->

Use the package `recurse` (function `getRecursions`) to determine sites which are often visited.
<!-- Todo: either extend this task or use this as a possible challenge for the individual topics and replace this with similarity measures  -->


```{r,, echo = F, include = T}

## Task 5 #######################

library(recurse)
library(ggforce)

recurs <- wildschwein_BE_sf %>%
  filter(TierID == "001A") %>%
  dplyr::select(E,N,DatetimeUTC,TierID) %>%
  st_set_geometry(NULL) %>%
  as.data.frame() %>%
  getRecursions(100)

recurStats <- recurs$revisitStats

recurStats <- recurStats %>%
  group_by(coordIdx) %>%
  summarise(
    number_of_visits = max(visitIdx),
    x = unique(x),
    y = unique(y),
    total_time = sum(timeInside),
    max_time = max(timeInside),
    mean_time = mean(timeInside)
  )

data1 = filter(recurStats, number_of_visits > 30)
wildschwein_BE_sf %>%
  ungroup() %>%
  filter(TierID == "001A") %>%
  ggplot(aes(E,N)) +
  geom_point(alpha = 0.4, colour = "grey") +
  geom_circle(data = data1, alpha = 0.5, aes(x0 = x,y0 = y,fill = mean_time,r = 100),inherit.aes = F) +
  coord_fixed(1)

```

## Solutions (RCode)

```{r code=readLines('14_Week4/RFiles/W04_01_Exercise.R'), results='asis', echo = T, include=T, eval=F}
```
