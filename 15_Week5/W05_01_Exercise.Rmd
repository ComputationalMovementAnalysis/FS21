# Exercise 5

## Learning Outcomes
- You are able to access state-of-the-art spatial data within R and know basic operations for annotating your trajectories with geographic context.

## Prerequisites

## Preperation

Open your R Project from last week. Either run your own script from last week or the following lines to transform the data into the form we need for today's exercise. *Important: Reinstall the package `CMAtools` since we have a few updates.* 


```{r, echo = T, include=T, eval = F}
devtools::install_git("https://github.engineering.zhaw.ch/PatternsTrendsEnvironmentalData/CMAtools.git") # Reinstall this package, since we have a few updates

```


```{r, echo = T, include = T, eval = T}
library(tidyverse)
library(CMAtools)
library(sf)
library(ggspatial)
library(raster)

# Import as tibble
wildschwein_BE <- read_delim("../CMA_FS2018_Filestorage/wildschwein_BE.csv",",")


# Convert to sf-object
wildschwein_BE = st_as_sf(wildschwein_BE, coords = c("Long", "Lat"), crs = 4326,remove = FALSE)

# transform to CH1903 LV95
wildschwein_BE <- st_transform(wildschwein_BE, 2056)

# Add geometry as E/N integer Columns
wildschwein_BE <- st_coordinates(wildschwein_BE) %>%
  cbind(wildschwein_BE,.) %>%
  rename(E = X) %>%
  rename(N = Y)

# Compute timelag, steplength and speed
wildschwein_BE <- wildschwein_BE %>%
  group_by(TierID) %>%
  mutate(
    timelag = as.numeric(difftime(lead(DatetimeUTC),DatetimeUTC,units = "secs")),
    steplength = euclid(lead(E, 1),lead(N, 1),E,N),
    speed = steplength/timelag
  )

```

## Tasks

### Tasks 1: Import and visualize spatial data

- Import the dataset `Feldaufnahmen_Fanel_2016.shp` (`read_sf()`) and save it to the variable `fanel2016`.
- Transform the coordinates to `CH1903+ LV95`
- Filter the dataset `wildschwein_BE` to the period 01.04.2016 to 30.09.2016 and store the data in a new variable (`wildschwein_BE_2016`)
- create a minimum convex polygon for each individual in `wildschwein_BE_2016` and store it in a new variable (`mcp2016`)
- import the file `pk100_BE_2056.tif`
- Create a map with the layers `pk100_BE_2056.tif`, `fanel2016` and `mcp2016`

```{r, echo = F, include=T, eval = T}

library(lubridate)

fanel2016 <- read_sf("../CMA_FS2018_Filestorage/Kulturen/Feldaufnahmen_Fanel_2016.shp") %>%
  st_transform(2056)

pk100_BE <- brick("../CMA_FS2018_Filestorage/pk100_BE_2056.tif")


wildschwein_BE_2016 <- wildschwein_BE %>%
  filter(DatetimeUTC >= as.Date("2016-04-01")) %>%
  filter(DatetimeUTC <= as.Date("2016-09-30"))


mcp2016 <- wildschwein_BE_2016 %>%
  group_by(TierID) %>%
  summarise() %>%
  st_convex_hull()


write_sf(mcp2016,"mcp2016.shp")


ggplot(fanel2016, aes(fill = Frucht)) + 
  annotation_spraster(pk100_BE) +
  geom_sf(alpha = 0.3) +
  geom_sf(data = mcp2016, aes(colour = TierID), inherit.aes = F, alpha = 0.1,lwd = 2) +
  theme(legend.position = "bottom")
  
```


### Task 2: Extract spatial information

We would like to know what crop was most used during what time. Use `st_join()` to extract the attributes from `fanel2016` with `wildschwein_BE_2016`. Visualize the number of samples in each category of `Frucht` over the course of the filtered time period.

```{r, echo = F, include=T, eval = T, fig.cap="The number of samples per category *per week* from April to September 2014."}
wildschwein_BE_2016 <- wildschwein_BE_2016 %>%
  st_join(dplyr::select(fanel2016,Frucht))


frucht_remove <- c("0","Flugplatz","Rhabarber","Zucchetti")

wildschwein_BE_2016 %>%
  as.data.frame() %>%
  mutate(week = floor_date(DatetimeUTC,"weeks")) %>%
  group_by(week,Frucht) %>%
  summarise(n = n()) %>%
  filter(!Frucht %in% frucht_remove) %>%
  filter(Frucht != "NA") %>%
  ggplot(aes(week,n, group = Frucht)) + 
  geom_line() +
  labs(x = "Time",y = "Number of Samples") +
  facet_wrap(~Frucht) +
  theme_minimal()

```


### Task 3

Think of other ways you could visually explore the spatio temporal pattern of wild boar in relation to the crops. For example;

- Visits in relation to availability
- Normalized usage (e.g. 1 equalling to the temporal maximum of each crop)


<!-- Rasterdatensatz importieren, ggf. DHM oder DTM-DHM um Veg.HÃ¶he zu ermitteln -->


### Task 4

```{r}

raster

```




### Task 8: Determine revisited sites

Use the package `recurse` (function `getRecursions`) to determine sites which are often visited.


```{r,, echo = F, include = T}

## Task 5 #######################

library(recurse)
library(ggforce)

recurs <- wildschwein_BE %>%
  filter(TierID == "001A") %>%
  dplyr::select(E,N,DatetimeUTC,TierID) %>%
  st_set_geometry(NULL) %>%
  as.data.frame() %>%
  getRecursions(100)

recurStats <- recurs$revisitStats

recurStats <- recurStats %>%
  group_by(coordIdx) %>%
  summarise(
    number_of_visits = max(visitIdx),
    x = unique(x),
    y = unique(y),
    total_time = sum(timeInside),
    max_time = max(timeInside),
    mean_time = mean(timeInside)
  )

data1 = filter(recurStats, number_of_visits > 30)
wildschwein_BE %>%
  ungroup() %>%
  filter(TierID == "001A") %>%
  ggplot(aes(E,N)) +
  geom_point(alpha = 0.4, colour = "grey") +
  geom_circle(data = data1, alpha = 0.5, aes(x0 = x,y0 = y,fill = mean_time,r = 100),inherit.aes = F) +
  coord_fixed(1)

```
