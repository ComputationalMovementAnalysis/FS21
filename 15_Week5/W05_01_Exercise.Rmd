# Exercise 5

## Learning Outcomes
- You are able to process spatial data (vector and raster) within R, including creating simple maps within R.
- You know basic operations for semantically annotating your trajectories with geographic context.

## Preperation

```{r}
#- header3 Preperation
#- chunkstart
```

Open your R Project from last week. Either run your own script from last week or the following lines to transform the data into the form we need for today's exercise.


```{r, echo = T, include = T, eval = T}
library(tidyverse)
library(sf)
library(ggspatial)
library(raster)

# Import as tibble
wildschwein_BE <- read_delim("00_Rawdata/wildschwein_BE.csv",",")


# Convert to sf-object
wildschwein_BE = st_as_sf(wildschwein_BE, coords = c("Long", "Lat"), crs = 4326,remove = FALSE)

# transform to CH1903 LV95
wildschwein_BE <- st_transform(wildschwein_BE, 2056)

# Add geometry as E/N integer Columns
wildschwein_BE <- st_coordinates(wildschwein_BE) %>%
  cbind(wildschwein_BE,.) %>%
  rename(E = X) %>%
  rename(N = Y)



```

```{r}
#- chunkend
```
## Tasks

### Tasks 1: Import and visualize spatial data

```{r}
#- header3 Task 1
#- chunkstart
```

- Import the vector dataset `Feldaufnahmen_Fanel_2016.shp` from moodle with `read_sf()` and save it to the variable `fanel2016`. The file .shp stands for Shapefile, which is a simple format for spatial vector data (points, lines, or polygons). This shapefile contains vector data about cultivated crops in the study area.
- Transform the coordinates to `CH1903+ LV95`.
- Filter the dataset `wildschwein_BE` to the months May, June and July of 2016 and store the data in a new variable (`wildschwein_BE_2016`).
- Create a minimum convex polygon for each individual in `wildschwein_BE_2016` and store it in a new variable (`mcp2016`)
- Create a map with the layers `fanel2016` and `mcp2016`.

```{r, echo = F, include=T, eval = T,fig.height=9}

library(lubridate)
library(tmap)

fanel2016 <- read_sf("00_Rawdata/Feldaufnahmen_Fanel_2016.shp") %>%
  st_transform(2056)



max(wildschwein_BE$DatetimeUTC)


wildschwein_BE_2016 <- wildschwein_BE %>%
  filter(DatetimeUTC > "2015-01-05",DatetimeUTC < "2015-07-31")

mcp2016 <- wildschwein_BE_2016 %>%
  group_by(TierID) %>%
  summarise() %>%
  st_convex_hull()


tm_shape(fanel2016) + 
  tm_polygons(col = "Frucht") +
  tm_shape(mcp2016) +
  tm_borders(lwd = 3,lty = 2)

```

```{r}
#- chunkend
```



### Task 2: Annotate Trajectories from vector data
```{r}
#- header3 Task 2
#- chunkstart
```
Now we would like to know what crop was most visited by our wild boar, and at what time. To this end, use `st_join()` to attach the attributes from `fanel2016` to your trajectory data `wildschwein_BE` (semantic annotation). Visualize the number of sample points in each category of `Frucht` over the course of the filtered time period.

```{r, echo = F, include=T, eval = T, fig.cap="The number of samples per category *per week* from May to July 2015."}
wildschwein_BE_2016 <- wildschwein_BE_2016 %>%
  st_join(dplyr::select(fanel2016,Frucht))


wildschwein_BE_2016 %>%
  st_set_geometry(NULL) %>%
  mutate(week = floor_date(DatetimeUTC,"weeks")) %>%
  group_by(TierID,week,Frucht) %>%
  summarise(n = n()) %>%
  filter(!Frucht %in% c("0","Flugplatz","Rhabarber","Zucchetti","NA")) %>%
  ggplot(aes(week,n, colour = TierID)) + 
  geom_line() +
  labs(x = "Time",y = "Number of Samples") +
  facet_wrap(~Frucht) +
  theme_minimal()

```

```{r}
#- chunkend
```
### Task 3: Explore annotated trajectories
Think of other ways you could visually explore the spatio-temporal patterns of wild boar in relation to the crops. 

Ideas:

- For example, in the visualisation above, we did not account for the different availability of the different crops. Potatoes ("Kartoffeln") are seemingly not visited at all, while rapeseed ("Raps") has high visitation from May to June. Maybe this is due to the fact that there are mostly rapeseed fields and basically no potatoe fields. How could you consider availability in the visulisation?
- Exlpore the circadian rhythm / daily patterns of crop visitations. 


### Task 4: Annotate Trajectories from raster data
```{r}
#- header3 Task 4
#- chunkstart
```
In terms of raster data, we have prepared a [Normalised Digital Surface Model (nDSM)](https://gisgeography.com/lidar-light-detection-and-ranging/)^[The nDSM was created by calculating the difference between the [digital surface models (DSM)](https://www.geo.apps.be.ch/de/geodaten/suche-nach-geodaten.html?view=sheet&guid=094ce943-6ad7-4f07-aa9f-d8eb17c5cb38&catalog=geocatalog&type=complete&preview=search_list) and the [digital terrain model (DTM)](https://www.geo.apps.be.ch/de/geodaten/suche-nach-geodaten.html?view=sheet&guid=490de97b-8932-4ef7-9d13-e89ef41eeb4b&catalog=geocatalog&type=complete&preview=search_list) obtained from the [geoportal from the canton Bern](https://www.geo.apps.be.ch/de/geodaten/suche-nach-geodaten.html). ], which provides information on the height of topological features on the ground. Since our wild boar usually use natural landscapes, the nDSM is a good approximation of vegitation height. This nDSM is available on moodle (`nDSM.tif`). Import this data with `raster()`and attach the respective raster values to the point data in your `sf` object (`wildschwein_BE_2016`). Explore the dataset similar to the crop data in task 2/3. Explore again spatio-temporal relations!


```{r, echo = F, include=T, eval = T, fig.cap="An example of a temporal exploration of the data obtained from the nDSM."}
ndsm <- raster("00_Rawdata/nDSM.tif")

wildschwein_BE_2016 <- wildschwein_BE_2016 %>%
  mutate(dod = raster::extract(ndsm,.))


wildschwein_BE_2016 %>%
  st_set_geometry(NULL) %>%
  mutate(
    hour = hour(round_date(DatetimeUTC,"1 hours"))
    ) %>%
  group_by(TierID,hour) %>%
  summarise(
    mean = mean(dod,na.rm = T),
    sd = sd(dod,na.rm = T),
    up = mean+sd,
    do = mean-sd
    ) %>%
  ggplot(aes(x = hour,y = mean,ymin = do, ymax = up, colour = TierID,fill = TierID)) +
  geom_ribbon(alpha = 0.4) +
  geom_line() +
  labs(x = "nDSM",
    title = "nDSM values as an approximation for vegitation hight",
    subtitle = "The line represents the mean nDSM value and the ribbon one standard deviation") +
  facet_wrap(~TierID) +
  theme_minimal()
    
  

```

```{r}
#- chunkend
```
